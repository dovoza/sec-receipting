//Angular Modules
var receipt = angular.module('receipt',[]);

//****************************************************************************
// SERVICES
//****************************************************************************

// MANAGE USERS DATA SERVICE
receipt.service('manageUserData', ['$http', function($http){
	this.insertUser = function(user){
	
		return $http.post('/addNewUser', user);
	};

	this.authenticate = function (loginUser) {
		return $http.post('/userAuthenticate', loginUser);
	}

	this.getUsers = function () {
		return $http.post('/showAllUsers');
	};

	this.getLogdInUser = function () {
		return $http.post('/getLogdInUser');
	}

	this.getBatchInfo = function() {
		return $http.post('/')
	}

	this.getAutoIncVals = function(stn){
		var stnCode = stn;
		var getValues = {station:stnCode};
		return $http.post('/getValues', getValues);
	}

}]);

// GET STATION
receipt.factory('getParams', function($http) { 
    return $http.post('http://localhost:3080/readStationParams');
});

// LOG EVENTS
receipt.service('recSwitch', ['$http',function($http) {
	this.insertLog = function(log) {
		return $http.post('/addNewLog', log);
	}
}]);

receipt.factory('recTypeService', function($http){
	var recTypes = {};

	recTypes.payMethSPU = "--Select--";
	recTypes.payMethCP = "--Select--";
	recTypes.payMethOP = "--Select--";
	recTypes.payMethDP = "--Select--";
	recTypes.payMethVT = "--Select--";

	recTypes.activeTab = "";
	recTypes.actTabPayMeth = "--Select--";

	recTypes.getPayMethSPU = function(){
		return recTypes.payMethSPU;
	}

	recTypes.setPayMethSPU = function(payMeth){
		recTypes.payMethSPU = payMeth;
	}

	recTypes.getPayMethCP = function(){
		return recTypes.payMethCP;
	}

	recTypes.setPayMethCP = function(payMeth){
		recTypes.payMethCP = payMeth;
	}

	recTypes.getPayMethOP = function(){
		return recTypes.payMethOP;
	}

	recTypes.setPayMethOP = function(payMeth){
		recTypes.payMethOP = payMeth;
	}

	recTypes.getPayMethDP = function(){
		return recTypes.payMethDP;
	}

	recTypes.setPayMethDP = function(payMeth){
		recTypes.payMethDP = payMeth;
	}

	recTypes.getPayMethVT = function(){
		return recTypes.payMethVT;
	}

	recTypes.setPayMethVT = function(payMeth){
		recTypes.payMethSPU = payMeth;
	}

	recTypes.setActiveTab = function(myTab){
		recTypes.activeTab = myTab;
	}

	recTypes.setPayMeth = function(myPayMeth){
		recTypes.actTabPayMeth = myPayMeth;
	}

	return recTypes;

});

//****************************************************************************
// CONTROLLERS
//****************************************************************************

// USERS CONTROLLER
receipt.controller('manageUsers',['$scope', '$rootScope','$http', '$compile', 'manageUserData','getParams','recSwitch',  function($scope, $rootScope, $http, $compile, manageUserData, getParams, recSwitch){
	
	$scope.loginstatus = true;
	$scope.hasuserinfo = false;
	$scope.loginState = "Not Logged In!"
	$scope.adminrole = false;
	$scope.suprole = false;
	$scope.cashierrole = false;
	$scope.reprole = false;
	$scope.isAdmin = false;
	$scope.isSup = false;
	$scope.isCashier= false;
	$scope.isReporter = false;
	$scope.alert = false;
	$scope.ustnNum = '--select--';
	$scope.hasLoginError = false;
	$scope.loginError = "Enter Your id";

	// get Station values from local station params file
	$scope.stationParams = function () {
		getParams.success(function (data){
			$rootScope.stn = data.stnName;
			$rootScope.stnCode = data.stnBatchCode;
			$rootScope.stnNo = data.stnId;
			console.log("You are logged in on station: "+ $scope.stn +" with code "+ $scope.stnCode);
		});
	}
	// Initialise station values
	$scope.stationParams();

	// Logout function
	$scope.logout = function (){
		window.location.reload(true); 
	}

	// Find if user logged in today by comparing today's date with the last login date from log collection
	$scope.calDateDiff = function (logDate) {
		logdDate = new Date(logDate);
		// User current log in date
		var today = new Date();
		var todayDay = today.getDate();
		var todayMon = today.getMonth();
		var todayYear = today.getFullYear();

		console.log("Your Current date : " + todayDay+','+ todayMon+','+ todayYear);

		// User last log in date
		var logDay = logdDate.getDate();
		var logMon = logdDate.getMonth();
		var logYear = logdDate.getFullYear();

		console.log("Your Login date is : " + logDay + ','+logMon+','+logYear);
		if ((todayDay == logDay) && (todayMon == logMon) && (todayYear == logYear)) {
			$scope.logginToday = true;
		}else {
			$scope.logginToday = false;
		}

		console.log("Your date difference variable says " + $scope.logginToday);
	}

	// get users' last login log from log collection
	$scope.getUserLog = function(user) {
		var user = {uname: user};
		$http.post('/getUserLog', user).success(function(data) {
			if (!(data.length == 0)){
				$scope.userLog = data[0];
				$scope.calDateDiff(data[0].time);
				console.log("Last Login Time is "+data[0].time);
			}
		});
	}

	$scope.getPrevBatch = function () {
		$http.post('/getBatch', {username: $scope.uname}).success(function(data) {
			$scope.latestBatch = data.batchNo;
			console.log(data);
		});
	}

	$scope.getAutInVals = function () {
		// get station previous batch number and increment by one
		var getValues = {station:$scope.stnCode};

		$http.post('/getValues', getValues).success(function (data){
			$rootScope.newBatchNo = data.batchNo + 1;
			console.log("The batch No is "+ $rootScope.newBatchNo);
			console.log(data);
		});
	}

	$scope.incrementBatchNo = function (stn, batchNo) {
		var updateBatch = {station:stn, batchNum: batchNo};
		$http.post('/incrementBatch', updateBatch).success(function (resp){
			console.log(resp)
		}); 
	}

	// Create new batch
	$scope.createNewBatch = function() {

		// call function(station last batch number increment val increased by one)
		$scope.getAutInVals();

		setTimeout(function () {
			// create new batch number
			$rootScope.newBatchNum = $scope.stnCode + $rootScope.newBatchNo;
			console.log("Your station code is "+$scope.stnCode);
			console.log("Your batch number is " +$rootScope.newBatchNo);
			console.log("Your new batchNo is " + $rootScope.newBatchNum);
		
			var newbatch = {batchNo : $rootScope.newBatchNum, openBy : $scope.uname, status : "open", timeOpened: Date().toString(), station:$scope.stn};
			$http.post('/createNewBatch', newbatch).success(function(resp) {
				console.log(resp);
				$scope.incrementBatchNo($scope.stnCode,$rootScope.newBatchNo);
			});
		},1000);
	}

	// create batch
	$scope.createBatch = function () {
			$scope.getUserLog($scope.uname);
			setTimeout(function (){
				console.log($scope.userLog);
				console.log($scope.logginToday);

				if (!$scope.logginToday){										
					$scope.createNewBatch();
					console.log("creating new batch");
				}else{													
					$scope.getPrevBatch();
					setTimeout(function () {
						$rootScope.newBatchNum = $scope.latestBatch;
						console.log("The new batch number is " +$rootScope.newBatchNum);	
						console.log("Taking default");
					}, 1000);

				}// end first else
			},800);
	}

	$scope.validate = function(){
		var id = $scope.uname;
		$scope.loginErrorMsgs = [];
		$scope.userformroles = [];
		var userroleError = "Choose at least one role";
		var userNpssWdError = "Incorrect username/password combination";
		var userStnError = "Wrong station";
		var daemonError = "Receipt daemon not started";

		//get login values from form and set loginuser
		var loginUser = {uname: $scope.uname, passkey: $scope.passkey};

		//authenticate user
		manageUserData.authenticate(loginUser).success(function (data){
			//user values from database
            $scope.username = data.uname;
	      	$scope.userpass = data.passkey;
	      	$scope.userstation = data.station;
	      	$scope.useroles = data.roles;

	      	//station number from local file
	      	$scope.stnNo = $rootScope.stnNo;

	      	if ($scope.uname != $scope.username && $scope.passkey != $scope.userpass) {
	      		$scope.loginErrorMsgs.push(userNpssWdError);
				$scope.hasLoginError = true;
			} else if (!$scope.adminrole && !$scope.suprole && !$scope.cashierrole && !$scope.reprole) {
				$scope.loginErrorMsgs.push(userroleError);
				$scope.hasLoginError = true;
	      	} else if ($scope.cashierrole && ($scope.stnNo == undefined)) {
	      		$scope.loginErrorMsgs.push(daemonError);
				$scope.hasLoginError = true;
	      	}else {
      			if ($scope.adminrole || $scope.suprole || $scope.cashierrole || $scope.reprole) {
					$scope.loginstatus = false;
					$scope.hasLoginError = false;
				}

				$scope.loginState = "Logged In";

				// creating an array for useroles from the form
				if ($scope.adminrole){
					$scope.userformroles.push("admin");
				}
				if ($scope.suprole){
					$scope.userformroles.push("sup");
				}
				if ($scope.cashierrole){
					$scope.userformroles.push("cashier");
				}
				if ($scope.reprole){
					$scope.userformroles.push("rep");
				}

				if ($scope.userformroles.indexOf("admin") == 0) {
					$compile($('#adminTab').addClass('active'));
				} else if ($scope.userformroles.indexOf("sup") == 0) {
					$('#supTab').addClass('active');
				} else if ($scope.userformroles.indexOf("cashier") == 0) {
					$('#cashierTab').addClass('active');
				} else if ($scope.userformroles.indexOf("rep") == 0) {
					$('#reportTab').addClass('active');
				}

				console.log("Roles chosen on the form " + $scope.userformroles[0]);

				// matching useroles from form and database
				if ($scope.adminrole && ($scope.useroles.indexOf("admin") > -1)) {
					$scope.isAdmin = true;
				};
				if ($scope.suprole && ($scope.useroles.indexOf("sup") > -1)) {
					$scope.isSup = true;
				};
				if ($scope.cashierrole && ($scope.useroles.indexOf("cashier") > -1)) {
					$scope.isCashier = true;
				};
				if ($scope.reprole && ($scope.useroles.indexOf("report") > -1)) {
					$scope.isReporter = true;
				};

				

				// create batch
	            $scope.createBatch()

				// log login event
				var log = {action : "userLogin", loggedInUser : $scope.username,station:$scope.userstation, time : Date()};
	          	recSwitch.insertLog(log).success(function () {
	            });
	        } // end if of else
        	}).error(function(error) {
            	console.log('Unable to insert customer: ' + error.message)
        });//authenticate function ends		
	}//validate function ends

	$scope.addUser = function(){
		//check if fields are filled
		if ($scope.usernme == undefined) {
			alert("Enter ID");
			return; 
		}
		//check if entered passwords match
		if ($scope.userpss !== $scope.userpss2) {
			alert("Entered Passwords do not match");
			return;
		}

		//initial user roles
		$scope.cashier = false;
		$scope.administrator = false;
		$scope.supervisor = false;
		$scope.report = false;

		//store user roles selected
		var userroles = [];

		if ($scope.adminRole) {
			userroles.push ("admin");
		}
		if ($scope.cashierRole){
			userroles.push ("cashier");
		}
		if ($scope.supRole){
			userroles.push ("sup");
		}
		if ($scope.reportRole){
			userroles.push ("report");
		}

		//create user object from form
		var newuser = {uname: $scope.usernme, passkey:$scope.userpss, firstname : $scope.firstname, lastname: $scope.lastname, station: $scope.stnNum, roles:userroles};

		manageUserData.insertUser(newuser)
            .success(function () {
                alert("User inserted");
                //var log = {action : "InsertUser", user : "Sec", inserted user : "sec", station : "station",time : date()};
                //recSwitch(log).success(function () {

                //})
                $scope.clearNewUser();
            }).
            error(function(error) {
                alert('Unable to insert customer: ' + error.message)
            });
	}//add user function ends

	$scope.showUsers = function(){
		manageUserData.getUsers().success(function (data) {
			$scope.users = data;
			mydata = '';
			data.forEach(function(user){
				mydata += '<tr><td>'+user.uname+'</td><td>'+user.firstname+'</td><td>'+user.lastname+'</td><td>'+user.station+'</td><td><a data-dismiss="modal" data-toggle="modal" href="#editUserWarlock" ng-click="getEditUser(\''+user.uname+'\')"><button>Update</button></a><a data-dismiss="modal" data-toggle="modal" href="#removeUserWarlock" ng-click="getEditUser(\''+user.uname+'\')"><button>Remove</button></a></td></tr>';
			});
			$('#showUsersTblData').html('');
			var $mydata1 = $(mydata).appendTo('#showUsersTblData');
			$compile($mydata1)($scope);
			//console.log($mydata);
			//$('#adminTab').on('click', '#adminUsers', function(){
				$('.rectable').dataTable();
				//});
			
		}).error(function () {
			alert("An unexpected error occured!" + error.message);
		});
	}

	$scope.clearNewUser = function () {
		$scope.usernme = '';
		$scope.userpss = '';
		$scope.userpss2 = '';
		$scope.firstname = '';
		$scope.lastname = '';
		$scope.stnNum = '';
		$scope.adminRole = '';
		$scope.supRole = '';
		$scope.cashierRole = '';
		$scope.reportRole = '';
	}

	$scope.clearLogin = function () {
		$scope.uname = '';
		$scope.passkey = '';
		$scope.ustnNum = '--select--';
		$scope.adminrole = '';
		$scope.suprole = '';
		$scope.cashierrole = '';
		$scope.reprole = '';
	}

	$scope.clearEditUser = function () {
		$scope.usernmeU = '';
		$scope.userpssU = '';
		$scope.firstnameU = '';
		$scope.lastnameU = '';
		$scope.adminRoleU = '';
		$scope.roleSupU = '';
		$scope.cashierRoleU = '';
		$scope.reproleU = '';
	}

	$scope.getEditUser = function (uName) {
		var uname = uName;
		$scope.cuname = '';
		$http.post('/getUser/' + uname).success(function(data) {
	      	$scope.usernmeU = data.uname;
	      	$scope.userpssU = data.passkey;
	      	$scope.firstnameU = data.firstname;
	      	$scope.lastnameU = data.lastname;
	      	$scope.currentStnU = data.station;
	      	var useroles = data.roles; //array of user roles

	      	var log = {action : "getUpdateUser", actionBy:$scope.uname, updateUser:$scope.usernmeU, station : "station", time : Date().toString()};
            	recSwitch.insertLog(log).success(function () {
            });

	      	// used to display edit user form when user is found
	      	$scope.hasuserinfo = true;

	      	//retrieve user roles
	      	if (useroles.indexOf("admin") > -1) {
	      		$scope.adminRoleU = true;
	      	}
	      	if (useroles.indexOf("sup") > -1) {
	      		$scope.roleSupU = true;
	      	}
	      	if (useroles.indexOf("cashier") > -1) {
	      		$scope.cashierRoleU = true;
	      	}
	      	if (useroles.indexOf("report") > -1) {
	      		$scope.reproleU = true;
	      	}
	    });// $http.get ends
	}

	$scope.updateUser = function (user) {
		var userrolesU = [];
		var id = user;

		//store selected user roles
		if ($scope.adminRoleU) {
			userrolesU.push ("admin");
		}
		if ($scope.cashierRoleU){
			userrolesU.push ("cashier");
		}
		if ($scope.roleSupU){
			userrolesU.push ("sup");
		}
		if ($scope.reportRoleU){
			userrolesU.push ("report");
		}

		// create the user object
		var updateuser = {uname: $scope.usernmeU, passkey:$scope.userpssU, firstname : $scope.firstnameU, lastname: $scope.lastnameU, roles:userrolesU};

		$http.post('/updateUser/' + id, updateuser).success(function (resp) {
			alert(resp);
			
		var log = {action : "UpdateUser", actionBy:"Bristo", updatedUser:$scope.usernmeU, station : "station", time : "20:20"};
            	recSwitch.insertLog(log).success(function () {
            });
				
			$scope.clearEditUser();

		}).error(function () {
			alert("Error");
		});
	}

	$scope.removeUser = function (uname) {

		var id = uname;
		$http.delete('/deleteUser/' + id).success(function(resp) {
			alert(resp);
		}).error(function () {
				alert("Error");
		});
	}

	$scope.closeTransferCashier = function () {
		$scope.hasuserinfo = false;
		$scope.cuname = '';
	}

	$scope.closeAssignCashier = function () {
		$scope.hasuserinfo = false;
		$scope.cuname = '';
	}


	$scope.cancelCashierTransfer = function () {
		$scope.hasuserinfo = false;
		$scope.clearEditUser();
	}

		$scope.cancelCashierAssign = function () {
		$scope.hasuserinfo = false;
		$scope.clearEditUser();
	}
	$scope.transfereCashier = function (id) {
		var cashierId = id;
		var updateCashier = {station:$scope.transferStn};
		$http.post('/transfereCashier/' + cashierId, updateCashier).success(function (resp){
			alert(resp);
		})
	}
	$scope.assignCashier = function (id) {
		var cashierId = id;
		var updateCashier = {station:$scope.transferStn, startDate : $scope.transferStartDate, endDate: $scope.transferEndDate};
		$http.post('/assignCashier/' + cashierId, updateCashier).success(function (resp){
			alert(resp);
		})
	}

	$scope.refreshCust = function(){
		$http.post('/refreshCust').success(function(resp){
			console.log(resp);
		});
	}

	$scope.refreshQuotes = function(){
		$http.post('/refreshQuotes').success(function(resp){
			console.log(resp);
		});
	}
}]);//manageUsers controller ends

//STATION CONTROLLER

receipt.controller('stationCtrl',['$scope','$http','$compile', 'recSwitch','$rootScope', function($scope, $http, $compile, recSwitch,$rootScope){
	var stationIdError = "Enter Station Id";
	var stationNameError = "Enter Station Name";
	var stationBCodeError = "Enter Station Batch Code";
	$scope.hasAddStationError = false;
	$scope.addStationErrorMsgs = [];
	$scope.hasStation = false;

	$scope.showStations = function(){
		$http.post('/showAllStations').success(function (data) {
			$rootScope.stations = data;
			stnData = '';
			data.forEach(function(station){
				stnData += '<tr><td>'+station.stnId+'</td><td>'+station.stnName+'</td><td>'+station.stnBatchCode+'</td><td><a data-dismiss="modal" data-toggle="modal" href="#editStationWarlock" ng-click="getEditStation(\''+station.stnId+'\')"><button>Update</button></a><a data-dismiss="modal" data-toggle="modal" href="#removeStationWarlock" ng-click="getEditStation(\''+station.stnId+'\')"><button>Remove</button></a></td></tr>';
			});
			$('#showStationsTblData').html('');
			var $stnData1 = $(stnData).appendTo('#showStationsTblData');
			$compile($stnData1)($scope);
			//console.log($mydata);
			//$('#adminTab').on('click', '#adminUsers', function(){
				$('.stntable').dataTable();
				
			var log = {action : "showStations", actionBy:"Bristo", station : "12", time : Date().toString()};
            	recSwitch.insertLog(log).success(function () {
            });
				
		}).error(function (){
			alert("An unexpected error occured!");
		});
	}

	// initialise station data
	$scope.showStations();

	$scope.addStation = function(){
		$scope.hasAddStationError = false;
		$scope.addStationErrorMsgs = [];

		if (($scope.stnId == null) && ($scope.stnName == null) && ($scope.stnBatchCode == null)){
			$scope.addStationErrorMsgs.push(stationIdError);
			$scope.addStationErrorMsgs.push(stationNameError);
			$scope.addStationErrorMsgs.push(stationBCodeError);
			$scope.hasAddStationError = true;
		}else if ($scope.stnId == null){;
			$scope.addStationErrorMsgs.push(stationIdError);
			$scope.hasAddStationError = true;
		}else if ($scope.stnName == null){;
			$scope.addStationErrorMsgs.push(stationNameError);
			$scope.hasAddStationError = true;
		}else if ($scope.stnBatchCode == null){;
			$scope.addStationErrorMsgs.push(stationBCodeError);
			$scope.hasAddStationError = true;
		}else if (!Number($scope.stnId)) {
			$scope.addStationErrorMsgs.push("ID should be a number");
			$scope.hasAddStationError = true;
		}else{
			// station object definition
			var newstation = {stnId: $scope.stnId, stnName:$scope.stnName, stnBatchCode : $scope.stnBatchCode};

			$http.post('/addNewStation', newstation ).success(function (resp) {
				console.log(resp);
				$scope.clearNewStation();

			}).error(function () {
				alert("Error");
			});
		}
	};

	$scope.clearNewStation = function () {
		$scope.stnId = '';
		$scope.stnName = '';
		$scope.stnBatchCode = '';
	}

	$scope.getEditStation = function (stnId) {
		$scope.hasStation = true;
		var id = stnId;
		
		$http.post('/getStation/' + id).success(function(data) {
			$scope.editStn = data;
	      	$scope.stnIdU = data.stnId;
	      	$scope.stnNameU = data.stnName;
	      	$scope.stnBatchCodeU = data.stnBatchCode;	  	      		      	
	    });// $http.post ends
	}

	$scope.getParamStation = function (stnId) {
		$scope.hasStation = true;
		var id = stnId;
		
		$http.post('/getStation/' + id).success(function(data) {
	      	$scope.stnIdParam = data.stnId;
	      	$scope.stnNameParam = data.stnName;
	      	$scope.stnBatchCodeParam = data.stnBatchCode;
	      	$scope.stnLastBatchParam = data.stnLastBatch;
	      	$scope.stnLastReceiptParam = data.stnLastReceipt;      		      	
	    });// $http.post ends
	}

	$scope.clearStationParam = function () {
		$scope.stnNumParam = '';
	    $scope.stnIdParam = '';
	    $scope.stnNameParam = '';
	    $scope.stnBatchCodeParam = '';
	    $scope.stnLastBatchParam = '';
	    $scope.stnLastReceiptParam = '';
	}
	// to collapse the setstation update form
	$scope.closeSetParams = function (){
		$scope.clearStationParam();
		$scope.hasStation = false;
	}

	$scope.updateStation = function (id) {
		//station object definition
		var updatestation = {stnId: $scope.stnIdU, stnName:$scope.stnNameU, stnBatchCode : $scope.stnBatchCodeU, stnLastBatch: $scope.stnLastBatchU, stnLastReceipt:$scope.stnLastReceiptU};

		$http.post('/updateStation/' + id, updatestation).success(function (resp) {
			alert(resp);
			$scope.clearEditStation();
		}).error(function () {
			alert("Error");
		});
	}

	$scope.setStationParams = function () {

		var systemparams = {stnId: $scope.stnIdU, stnName:$scope.stnNameU, stnBatchCode : $scope.stnBatchCodeU, stnLastBatch: $scope.stnLastBatchU, stnLastReceipt:$scope.stnLastReceiptU};

		$http.post('http://localhost:3080/setStationParams', systemparams).success(function (resp) {
			alert(resp);
			$scope.clearEditStation();
		}).error(function () {
			alert("Error");
		});
	}

	$scope.clearEditStation = function() {
		$scope.editStn = '';
	      	$scope.stnIdU = '';
	      	$scope.stnNameU = '';
	      	$scope.stnBatchCodeU = '';
	      	$scope.stnLastBatchU = '';
	      	$scope.stnLastReceiptU = '';	 
	}

	$scope.removeStation = function (stnId) {

		var id = stnId;
		$http.delete('/deleteStation/' + id).success(function(resp) {
			alert(resp);
		}).error(function () {
				alert("Error");
		});
	}

}]);// station controller ends

// CUSTOMER CONTROLLER !!

receipt.controller('customerCtrl', ['$scope','$http','$compile','recSwitch', function($scope, $http,$compile, recSwitch){

	$scope.showCustomers = function(){
		$http.post('/showAllCustomers').success(function (data) {
			custData = '';
			data.forEach(function(customer){
				custData += '<tr><td>'+customer.Account+'</td><td>'+customer.NAME+'</td><td>'+customer.DEPOT_NAME+'</td><td>'+customer.Address+'</td></tr>';
			});
			
			$('#showCustTblData').html('');
			var $custData1 = $(custData).appendTo('#showCustTblData');
			$compile($custData1)($scope);
			//console.log($mydata);
			//$('#adminTab').on('click', '#adminUsers', function(){
				$('.custable').dataTable();
				//});
						
		}).error(function (){
			console.log("An unexpected error occured!");
		});
	}

	//$scope.showCustomers();

	$scope.addCustomer = function(){

		if ($scope.custNo == undefined) {
			alert("Enter Customer ID");
			return; 
		};
		// customer object definition
		var newcustomer = {CUSTNO: $scope.custNo, CUSTNAME:$scope.custName, CUSTADDR1 : $scope.custAddr1, CUSTADDR2: $scope.custAddr2, CUSTADDR3: $scope.custAddr3, CUSTREF:$scope.custRef};

		$http.post('/addNewCustomer', newcustomer ).success(function (resp) {
			alert(resp);
			$scope.clearNewCustomer();

		}).error(function () {
			alert("Error");
		});
	}

	$scope.clearNewCustomer = function () {
		$scope.custNo = '';
		$scope.custName = '';
		$scope.custAddr1 = '';
		$scope.custAddr2 = '';
		$scope.custAddr2 = '';
		$scope.custRef = '';
	};


	$scope.getEditCustomer = function (custno) {
		var id = custno;
		
		$http.post('/getCustomer/' + id).success(function(data) {
			console.log(data);
	      	$scope.custNoU = data[0].CUSTNO;
	      	$scope.custNameU = data[0].CUSTNAME;
	      	$scope.custAddr1U = data[0].CUSTADDR1;
	      	$scope.custAddr2U= data[0].CUSTADDR2;
	      	$scope.custAddr3U = data[0].CUSTADDR3;
	      	$scope.custRefU = data[0].CUSTREF; //array of user
	      
	    });// $http.get ends
	}

	$scope.updateCustomer = function (custId) {
		var id = custId;
		if (id == undefined) {
			alert("Id empty");
			return;
		}
		// station object definition
		var updatecustomer = {custno: $scope.custNoU, custName:$scope.custNameU, custAddr1 : $scope.custAddr1U, custAddr2: $scope.custAddr2U, custAddr3: $scope.custAddr3U, custRef:$scope.custRefU};

		$http.post('/updateCustomer/' + id, updatecustomer).success(function (resp) {
			alert(resp);
			$scope.clearEditCustomer();

		}).error(function () {
			alert("Error");
		});
	}

	$scope.removeCustomer = function (uname) {
		var id = uname;
		$http.delete('/deleteCustomer/' + id).success(function(resp) {
			alert(resp);
		}).error(function () {
				alert("Error");
		});
	}

	$scope.clearEditCustomer = function () {
		$scope.custIdU = '';
	    $scope.custNameU = '';
	    $scope.custAddr1 = '';
	    scope.custAddr2 = '';
	    $scope.custAddr3 = '';
	    $scope.custRefU = ''; //array of user
	}

}]);// customer controller ends

// RECEIPT CONTROLLER

receipt.controller('receiptCtrl', ['$scope','$rootScope','$http', 'getParams','recSwitch', 'recTypeService', 'manageUserData','$compile', function($scope, $rootScope, $http,  getParams, recSwitch, recTypeService, manageUserData, $compile){
	
	
	console.log("Your date is " + $scope.recDate);
	$scope.payMethSPU = recTypeService.getPayMethSPU();
	$scope.payMethCP = recTypeService.getPayMethCP();
	$scope.payMethOP = recTypeService.getPayMethOP();
	$scope.payMethDP = recTypeService.getPayMethDP();
	$scope.payMethVT = recTypeService.getPayMethVT();
	$scope.glCodeOP = "--Select--";
	$scope.glCodeAvail = true;
	$scope.cheqnum = null;
	$scope.glCode = "--Select--"
	$scope.newGLBox = false;
	$scope.hasinfo = false; // hide cancel receipt form

	$scope.$watch('payMethSPU', function(newValue,scope) {
		if (newValue == "Cheque"){
			$scope.choseChequeSPU = true;
			//$scope.resetMessagesDiv();
		} else {$scope.choseChequeSPU = false;
			//$scope.resetMessagesDiv();
		};
		$scope.recDate = Date().toString();
	});

	$scope.$watch('payMethCP', function(newValue,scope) {
		if (newValue == "Cheque"){
			$scope.choseChequeCP = true;
		} else {$scope.choseChequeCP = false;};
		$scope.recDate = Date().toString();
	});

	$scope.$watch('payMethOP', function(newValue,scope) {
		if (newValue == "Cheque"){
			$scope.choseChequeOP = true;
		} else {$scope.choseChequeOP = false;};
		$scope.recDate = Date().toString();
	});

	$scope.$watch('payMethDP', function(newValue,scope) {
		if (newValue == "Cheque"){
			$scope.choseChequeDP = true;
		} else {$scope.choseChequeDP = false;};
		$scope.recDate = Date().toString();
	});

	$scope.$watch('payMethVT', function(newValue,scope) {
		if (newValue == "Cheque"){
			$scope.choseChequeVT = true;
		} else {$scope.choseChequeVT = false;};
		$scope.recDate = Date().toString();
	});
	// END OF WATCHERS

	// Get current date/time	
	$scope.getDate = function () {
		var date = new Date();
		$scope.recDate = date.getFullYear()+ date.getMonth();
	}

	// get station params
	$scope.stationParams = function () {
		getParams.success(function (data){
			$scope.station = data.stnName;
			$scope.stationNum = data.stnId;
			$scope.stationCode = $rootScope.stnCode;
			//$scope.batchNo = $rootScope.newBatchNum;
		});
	}

	// Initialise station values
	$scope.stationParams();

	$scope.getCustomer = function (custNo, type) {
		var num = custNo;

		$http.post('/getCustomer', {custno:num}).success(function(data){

			// customer information from database
			var log = {action : "getCustomer", actionBy:"Bristo", retrievedCustomer:data.NAME, station:"12", time:Date().toString()};
            	recSwitch.insertLog(log).success(function () {
            });
			if (type == 'spu'){
				$scope.customerSPU = data;
			}else{
				$scope.customerDP = data;
			}
	    });
	}

	$scope.getGlCodes = function () {
		$http.post('/getGlCodes').success(function(data) {
			// glcodes from database
			$scope.glCodes = data;
			var log = {action : "getGlCodes", actionBy:"Bristo", station:"12", time:Date().toString()};
            recSwitch.insertLog(log).success(function () {
            });
	    });	
	}

	$scope.getGlCodes();

	$scope.getQuotation = function (quoteRef){
		var ref = quoteRef;

		$http.post('/getQuotation', {QuoteDesc:ref}).success(function(data) {
			// quotation from database
			$scope.quotes = data;
	      	$scope.quotes.groupName = data.oppo_groupcustname;
	      	$scope.quotes.balance = data.Quot_grossamt;
	      	var log = {action : "getQuotations", actionBy:"Bristo",station:"12", time:Date().toString()};
            	recSwitch.insertLog(log).success(function () {
            });
	    });		
	}

	//show receipts
	$scope.showReceipts = function(){
		var stnCode = {station : $scope.stnCode};
		$http.post('/showAllReceipts', stnCode).success(function (data) {
			console.log("All receipts");
			console.log(data);
			recData = '';
			data.forEach(function(receipt){
				recData += '<tr><td>'+receipt.recNum+'</td><td>'+receipt.custName+'</td><td>'+receipt.cashier+'</td><td>'+receipt.recDate+'</td><td><a data-dismiss="modal" data-toggle="modal" ng-click="reprintReceipt(\''+receipt.recNum+'\')"><button>Print</button></a></td></tr>';
			});
			
			$('#showRecTblData').html('');
			var $recData1 = $(recData).appendTo('#showRecTblData');
			$compile($recData1)($scope);
			$('.rectable').dataTable();
				
						
		}).error(function (){
			console.log("An unexpected error occured!");
		});
	}
	// reprint receipt
	$scope.reprintReceipt = function(receiptNo) {
		$http.post('/getReceipt', {recNo:receiptNo}).success(function (data) {
			$scope.receiptR = data;
			console.log($scope.receiptR);
			console.log("the receipt type is "+$scope.receiptR.recType);

			if($scope.receiptR.recType == "spu") {
					//REPRINT SPU RECEIPT
		            spuRecR = [
					  	'<body>',
                        '<table>',
		                '<tr><td colspan=2><center><u><b>Swaziland Electricity Company</b></u></center></td></tr>',
                   		'<tr><td colspan=2><center><b>Payment Receipt</b></center></td></tr>',
					  	'<tr><td><span><b>Receipt No:</b></span></td><td><span><i>'+$scope.receiptR.recNum+'</i></span></td></tr>',
					  	'<tr><td><span><b>Batch No:</b></span></td><td><span><i>'+$scope.receiptR.recBatch+'</i></span></td></tr>',
					  	'<tr><td><span><b>Transaction No:</b></span></td><td><span><i>'+$scope.receiptR.transNo+'</i></span></td></tr>',
					  	'<tr><td><span><b>Date:</b></span></td><td><span><i>'+$scope.receiptR.recDate+'</i></span></td></tr>',
					  	'<tr><td><span><b>Account No:</b></span></td><td><span><i>'+$scope.receiptR.account+'</i></span></td></tr>',
					  	'<tr><td><span><b>Customer</b></span></td><td><span>'+$scope.receiptR.custName+'</span><br><span>'+$scope.receiptR.custAddr+'</span><br><span>'+$scope.receiptR.custCity+'</span></td><td>&nbsp;</td></tr>',
					  	'<tr><td><span><b>Pay Method:</b></span></td><td><span><i>'+$scope.receiptR.payMeth+'</i></span></td></tr>',
					  	'<tr><td><span><b>Amount:</b></span></td><td><span><i>E '+$scope.receiptR.amtdue+'</i></span></td></tr>',
					  	'<tr><td><span><b>Tendered:</b></span></td><td><span><i>E '+$scope.receiptR.amttendered+'</i></span></td></tr>',
					  	'<tr><td><span><b>Change:</b></span></td><td><span><i>E '+$scope.receiptR.change+'</i></span></td></tr>',
					  	'<tr><td><span><b>Cashier:</b></span></td><td><span><i>'+$scope.receiptR.cashier+'</i></span></td></tr>',
					  	'<tr><td><span><b>Station:</b></span></td><td><span><i>'+$scope.receiptR.station+'</i></span></td></tr>',
					  	'</table>',
					  	'</body>',
						'<hr>'].join('\n');
					//console.log(spuRec);
					$http.post('http://localhost:3080/print', {spuRec:spuRecR}).success(function (resp) {
				  	  	console.log(resp);
					});
				}else if ($scope.receiptR.recType == "deposits") {
					//REPRINT DEPOSITS RECEIPT
					capRecR = [
						'<body>',
                        '<table>',
                     	'<tr><td colspan=2><center><u><b>Swaziland Electricity Company</b></u></center></td></tr>',
		                '<tr><td colspan=2><center><b>Payment Receipt</b></center></td></tr>',
						'<tr><td><span><b>Receipt No:</b></span></td><td><span><i>'+$scope.receiptR.recNum+'</i></span></td></tr>',
						'<tr><td><span><b>Batch No:</b></span></td><td><span><i>'+$scope.receiptR.recBatch+'</i></span></td></tr>',
						'<tr><td><span><b>Transaction No:</b></span></td><td><span><i>'+$scope.receiptR.transNo+'</i></span></td></tr>',
						'<tr><td><span><b>Date:</b></span></td><td><span><i>'+$scope.receiptR.recDate+'</i></span></td></tr>',
						'<tr><td><span><b>Quotation:</b></span></td><td><span><i>'+$scope.receiptR.quoteRef+'</i></span></td></tr></table>',
						'<table><tr><td><span><b>Customer</b></span></td><td><span>'+$scope.quotes.custName+'</span><br></td></tr></table>',
						'<tr><td><span><b>Paid By:</b></span></td><td><span><i>'+$scope.receiptR.payMeth+'</i></span></td></tr>',
						'<tr><td><span><b>Amount:</b></span></td><td><span><i>E '+$scope.receiptR.amtdue+'</i></span></td></tr>',
						'<tr><td><span><b>Tendered:</b></span></td><td><span><i>E '+$scope.receiptR.amttendered+'</i></span></td></tr>',
					  	'<tr><td><span><b>Change:</b></span></td><td><span><i>E '+$scope.receiptR.change+'</i></span></td></tr>',
					  	'<tr><td><span><b>Cashier:</b></span></td><td><span><i>'+$scope.receiptR.cashier*'</i></span></td></tr>',
					  	'<tr><td><span><b>Station:</b></span></td><td><span><i>'+$scope.receiptR.station+'</i></span></td></tr>',
						'</table>',
						'</body>',
						'<hr>'].join('\n');
					  	//console.log(spuRec);
					  	$http.post('http://localhost:3080/print', {spuRec:capRecR}).success(function (resp) {
					    	console.log(resp);
						});				
				}else if ($scope.receiptR.recType == "capital"){
					//REPRINT CAPITAL RECEIPT
					capRecR = [
					  	'<body>',
                        '<table>',
                		'<tr><td colspan=2><center><u><b>Swaziland Electricity Company</b></u></center></td></tr>',
		                '<tr><td colspan=2><center><b>Payment Receipt</b></center></td></tr>',
					  	'<tr><td><span><b>Receipt No:</b></span></td><td><span><i>'+$scope.receiptR.recNum+'</i></span></td></tr>',
						'<tr><td><span><b>Batch No:</b></span></td><td><span><i>'+$scope.receiptR.recBatch+'</i></span></td></tr>',
						'<tr><td><span><b>Transaction No:</b></span></td><td><span><i>'+$scope.receiptR.transNo+'</i></span></td></tr>',
						'<tr><td><span><b>Date:</b></span></td><td><span><i>'+$scope.receiptR.recDate+'</i></span></td></tr>',
					  	'<tr><td><span><b>Quotation:</b></span></td><td><span><i>'+$scope.receiptR.quoteRef+'</i></span></td></tr>',
					  	'<tr><td><span><b>Customer</b></span></td><td><span>'+$scope.receiptR.custName+'</span><br></td></tr>',
					  	'<tr><td><span><b>Paid By:</b></span></td><td><span><i>'+$scope.receiptR.payMeth+'</i></span></td></tr>',
					  	'<tr><td><span><b>Amount:</b></span></td><td><span><i>E '+$scopereceiptR.receiptR.amtdue+'</i></span></td></tr>',
						'<tr><td><span><b>Tendered:</b></span></td><td><span><i>E '+$scope.receiptR.amttendered+'</i></span></td></tr>',
					  	'<tr><td><span><b>Change:</b></span></td><td><span><i>E '+$scope.receiptR.change+'</i></span></td></tr>',
					  	'<tr><td><span><b>Cashier:</b></span></td><td><span><i>'+$scope.receiptR.cashier*'</i></span></td></tr>',
					  	'<tr><td><span><b>Station:</b></span></td><td><span><i>'+$scope.receiptR.station+'</i></span></td></tr>',
					  	'</table>',
					  	'</body>',
						'<hr>'].join('\n');
					  	//console.log(spuRec);
					  	$http.post('http://localhost:3080/print', {spuRec:capRecR}).success(function (resp) {
					    	console.log(resp);
					  	});
				} else if ($scope.receiptR.recType == "visits") {
					//REPRINT VISITS RECEIPT
					vtRecR = [
					  	'<body>',
                        '<table>',
                		'<tr><td colspan=2><center><u><b>Swaziland Electricity Company</b></u></center></td></tr>',
		                '<tr><td colspan=2><center><b>Payment Receipt</b></center></td></tr>',
					  	'<tr><td><span><b>Receipt No:</b></span></td><td><span><i>'+$scope.receiptR.recNum+'</i></span></td></tr>',
						'<tr><td><span><b>Batch No:</b></span></td><td><span><i>'+$scope.receiptR.recBatch+'</i></span></td></tr>',
						'<tr><td><span><b>Transaction No:</b></span></td><td><span><i>'+$scope.receiptR.transNo+'</i></span></td></tr>',
						'<tr><td><span><b>Date:</b></span></td><td><span><i>'+$scope.receiptR.recDate+'</i></span></td></tr>',
					  	'<tr><td><span><b>Customer :</b></span></td><td><span><i>'+$scope.custName+'</i></span></td></tr>',
					  	'<tr><td><span><b>Method:</b></span></td><td><span><i>'+$scope.receiptR.payMeth+'</i></span></td></tr>',
					  	'<tr><td><span><b>Amount:</b></span></td><td><span><i>E '+$scopereceiptR.receiptR.amtdue+'</i></span></td></tr>',
						'<tr><td><span><b>Tendered:</b></span></td><td><span><i>E '+$scope.receiptR.amttendered+'</i></span></td></tr>',
					  	'<tr><td><span><b>Change:</b></span></td><td><span><i>E '+$scope.receiptR.change+'</i></span></td></tr>',
					  	'<tr><td><span><b>Cashier:</b></span></td><td><span><i>'+$scope.receiptR.cashier*'</i></span></td></tr>',
					  	'<tr><td><span><b>Station:</b></span></td><td><span><i>'+$scope.receiptR.station+'</i></span></td></tr>',
					  	'</table>',
						'</body>',
						'<hr>'].join('\n');
					//console.log(spuRec);
					$http.post('http://localhost:3080/print', {spuRec:vtRecR}).success(function (resp) {
					   console.log(resp);
					});
				} else if ($scope.receiptR.recType == "otherPayments") {
					//REPRINT OTHER PAYMENTS RECEIPT
					opRecR = [
					    '<body>',
                        '<table>',
                		'<tr><td colspan=2><center><u><b>Swaziland Electricity Company</b></u></center></td></tr>',
		                '<tr><td colspan=2><center><b>Payment Receipt</b></center></td></tr>',
					  	'<tr><td><span><b>Receipt No:</b></span></td><td><span><i>'+$scope.receiptR.recNum+'</i></span></td></tr>',
						'<tr><td><span><b>Batch No:</b></span></td><td><span><i>'+$scope.receiptR.recBatch+'</i></span></td></tr>',
						'<tr><td><span><b>Transaction No:</b></span></td><td><span><i>'+$scope.receiptR.transNo+'</i></span></td></tr>',
						'<tr><td><span><b>Date:</b></span></td><td><span><i>'+$scope.receiptR.recDate+'</i></span></td></tr>',
					  	'<tr><td><span><b>Customer :</b></span></td><td><span><i>'+$scope.custName+'</i></span></td></tr>',
					  	'<tr><td><span><b>Method:</b></span></td><td><span><i>'+$scope.receiptR.payMeth+'</i></span></td></tr>',
					  	'<tr><td><span><b>Amount:</b></span></td><td><span><i>E '+$scopereceiptR.receiptR.amtdue+'</i></span></td></tr>',
						'<tr><td><span><b>Tendered:</b></span></td><td><span><i>E '+$scope.receiptR.amttendered+'</i></span></td></tr>',
					  	'<tr><td><span><b>Change:</b></span></td><td><span><i>E '+$scope.receiptR.change+'</i></span></td></tr>',
					  	'<tr><td><span><b>Cashier:</b></span></td><td><span><i>'+$scope.receiptR.cashier*'</i></span></td></tr>',
					  	'<tr><td><span><b>Station:</b></span></td><td><span><i>'+$scope.receiptR.station+'</i></span></td></tr>',
					  	'</table>',
					  	'</body>',
						'<hr>'].join('\n');
					  	//console.log(spuRec);
					$http.post('http://localhost:3080/print', {spuRec:opRecR}).success(function (resp) {
					   	console.log(resp);
					});
				}
		});
	}

	$scope.getCashier = function () {
		$http.post('/getLogdInUser').success(function(data) {
	      	$scope.cashierName = data.firstname;
	      	$scope.cashierSurname = data.lastname;
	      	$scope.cashierUname = data.uname;
	      	var log = {action : "getCashier", actionBy:"Bristo", retrievedCashier:$scope.cashierName, station:"station", time:Date().toString()};
            	recSwitch.insertLog(log).success(function () {
            });
	      	
	    });
	}

	// initialise cashier so that if available on first receipt
	$scope.getCashier();

	$scope.updateAutoIncVals = function (stnCode,newRecNo, newTransNo) {
				
		// receipt object definition
		var updateValues = {station: stnCode, recNo:newRecNo, transNo:newTransNo};

		console.log("auto increment values");
		console.log(stnCode);
		console.log(newRecNo);
		$http.post('/updateAutoIncrements', updateValues).success(function(resp){
			}).error(function(){
				console.log("Error");
			});

	}

	$scope.generateRecNo = function () {
			//get receipting station code 
			var code = $scope.stnCode;
		
			// create receipt string without the zeros
			var str = "" + $scope.newRecNo;

			//add zeros to the string above and maintain 5 digits
			while (str.length < 5) {
				str = "0" + str;
			}
			// generate final receipt number
			$scope.RecNo = code + str;
	}

	$scope.getIncVals = function (){
		setTimeout(function () {
			var stn = $scope.stnCode;
			manageUserData.getAutoIncVals(stn).success(function (data){
				$scope.newRecNo = data.recNo + 1;
				$scope.generateRecNo();
				$scope.newTransNo = data.transNo + 1;
				$scope.newBatch = $rootScope.newBatchNum;
				console.log("Current Receipt Number is: " + $scope.newRecNo);
				console.log("Current batch Number is: " + $scope.newBatch);
				console.log("Current trans Number is: " + $scope.newTransNo);
				console.log("Your paymeth is " + $scope.payMethSPU);
			});
		}, 1000);
	}
	
	// initialize autoincrement values so that they are available on first receipt
	//$scope.getIncVals();

	$scope.updateQuotation = function () {
		
			console.log($scope.recamtCP);
			console.log($scope.quotes.balance);
				
			$scope.newBalance = $scope.quotes.balance - $scope.recamtCP;
				console.log($scope.newBalance);
			var updatedQuote = {qDescription: $scope.quoteRef, qBalance:$scope.newBalance};
			$http.post('/updateRecQuote', updatedQuote).success(function (resp) {
				
			});
	}

	$scope.updateAging = function () {
		
			console.log($scope.recamtSPU);
			console.log($scope.customerSPU.Current_Balance);
				
			$scope.newBalance = $scope.customerSPU.Current_Balance - $scope.recamtSPU;
			console.log($scope.newBalance);
			var updatedAging = {account: $scope.customerSPU.Account, balance:$scope.newBalance};
				$http.post('/updateAging', updatedAging).success(function (resp) {	
			});
	}

	$scope.insertGlCode = function () {
		var newGlCode = {glcode: $scope.glCodeOP2, glCodeDesc:$scope.glCodeDesc};
		$http.post('/addNewGlCode', newGlCode ).success(function (resp) {
		}).error(function () {
			alert("Error");
		});
	}

	$scope.openNewGLBox = function () {
		if ($scope.glCodeOP == "Other"){
			$scope.newGLBox = true;
			$scope.glCodeAvail = false;
			//$scope.glCodeOP = "";
		}
	}

	$scope.closeNewGLBox = function () {
		$scope.glCodeOP = '--Select--';
		$scope.newGLBox = false;
		$scope.glCodeAvail = true;
	}

	$scope.adminFee = function () {
		$scope.isAdminFee = true;
		$scope.recamtCP = "147.00";
		$scope.glCode = "HF889999A978";
	}

	$scope.insertRec = function (type) {
		
		var adminGlCode = "HF";
		var recType = type;
		var cashier = $scope.cashierName +" "+ $scope.cashierSurname;
		//create receipt number
		$scope.generateRecNo();	

		//console.log(recType);

		// receipt object definition
		if (recType == 'spu') {

			if ($scope.choseCheque) {
				$scope.chequeTot = $scope.recamtSPU;
			}
			var glCode = "HF008888000";
			var newCheque = {chequeTot:$scope.chequeTot, chequeNo: $scope.chequeNoSPU, bankCode: $scope.bankCodeSPU, drawerName: $scope.drawerNameSPU};
			
			$scope.paymentMethod = $scope.payMethSPU;
			$scope.change = $scope.changeamtSPU;
			$scope.CUSTOMERname = $scope.customerSPU.NAME;

			if ($scope.payMethSPU == "Cash") {
				var newRec = {recNum: $scope.RecNo, transNo: $scope.newTransNo, recBatch: $scope.newBatch, recDate: $scope.recDate, account: $scope.accountSPU,recType:recType, glCode: glCode , custName:$scope.customerSPU.NAME, 
					custAddr: $scope.customerSPU.Address, custCity: $scope.customerSPU.City,cashier: cashier, stnName:$scope.station, stnNum:$scope.stationNum, amtdue: Number($scope.recamtSPU) ,amttendered: Number($scope.tendamtSPU), change: Number($scope.changeamtSPU), 
				payMeth:$scope.payMethSPU};
			}else {			
				var newRec = {recNum: $scope.RecNo, transNo: $scope.newTransNo, recBatch:$scope.newBatch, recDate: $scope.recDate, account: $scope.accountSPU, recType:recType, glCode: glCode , custName:$scope.customerSPU.NAME, 
					custAddr: $scope.customerSPU.Address, custCity: $scope.customerSPU.City,cashier: cashier, stnName:$scope.station, stnNum:$scope.stationNum, amtdue: Number($scope.recamtSPU) ,amttendered: Number($scope.tendamtSPU), change: Number($scope.changeamtSPU), 
					payMeth:$scope.payMethSPU,cheQue: newCheque };
			}

                //Check if Receipt is Valid
                if ((($scope.paymentMethod == "Cash") || ($scope.paymentMethod == "Cheque"))&&($scope.change >= 0)&&($scope.CUSTOMERname != null)) {
			//PRINT SPU RECEIPT

	    var balance = Number($scope.customerSPU.Current_Balance) - Number($scope.recamtSPU);
            spuRec = [
			  '<body>',
              '<table>',
              '<tr><td colspan=2><center><u><b>Swaziland Electricity Company</b></u></center></td></tr>',
              '<tr><td colspan=2><center><b>Payment Receipt</b></center></td></tr>',
              '<tr><td><span><b>Receipt No:</b></span></td><td><span><i>'+$scope.RecNo+'</i></span></td></tr>',
              '<tr><td><span><b>Batch No:</b></span></td><td><span><i>'+$scope.newBatch+'</i></span></td></tr>',
              '<tr><td><span><b>Transaction No:</b></span></td><td><span><i>'+$scope.newTransNo+'</i></span></td></tr>',
              '<tr><td><span><b>Date:</b></span></td><td><span><i>'+$scope.recDate.substring(0,21)+'</i></span></td></tr>',
              '<tr><td><span><b>Account No:</b></span></td><td><span><i>'+$scope.accountSPU+'</i></span></td></tr>',
              '<tr><td><span><b>Customer</b></span></td><td><span>'+$scope.customerSPU.NAME+'</span><br><span>'+$scope.customerSPU.Address+'</span><br><span>'+$scope.customerSPU.City+'</span></td><td>&nbsp;</td></tr>',
              '<tr><td><span><b>Prev Balance</b></span></td><td><span><i>'+$scope.customerSPU.Current_Balance+'</i></span></td></tr>',
              '<tr><td><span><b>Pay Method:</b></span></td><td><span><i>'+$scope.payMethSPU+'</i></span></td></tr>',
              '<tr><td><span><b>Tendered:</b></span></td><td><span><i>'+$("#tendamtspu").text()+'</i></span></td></tr>',
              '<tr><td><span><b>Change:</b></span></td><td><span><i>'+$("#changeamtspu").text()+'</i></span></td></tr>',
              '<tr><td><span><b>Curr Balance</b></span></td><td><span><i>'+balance+'</i></span></td></tr>',
              '<tr><td><span><b>Cashier:</b></span></td><td><span><i>'+$scope.cashierName+'--'+$scope.cashierSurname+'</i></span></td></tr>',
              '<tr><td><span><b>Station:</b></span></td><td><span><i>'+$scope.station+'</i></span></td></tr>',
              '</table>',
              '</body>',
              '<hr>'].join('\n');
                          //console.log(spuRec);
                          $http.post('http://localhost:3080/print', {spuRec:spuRec}).success(function (resp) {
                            console.log(resp);
                          });
		}
		} else if (recType == 'capital') {

			if ($scope.choseCheque) {
				$scope.chequeTot = $scope.recamtCP;
			}

			$scope.paymentMethod = $scope.payMethCP;
			$scope.change = $scope.changeamtCP;
			$scope.CUSTOMERname = $scope.quotes.groupName;

			if ($scope.isAdminFee){
				var glCode = $scope.glCode;
			}else {
				var glCode = "HF008888089";
			}
			var newCheque = {chequeTot:$scope.chequeTot, chequeNo: $scope.chequeNoCP, bankCode: $scope.bankCodeCP, drawerName: $scope.drawerNameCP};

			if ($scope.payMethCP == "Cash") {
				var newRec = {recNum: $scope.RecNo, transNo: $scope.newTransNo, recBatch:$scope.newBatch, recDate: $scope.recDate, quoteRef: $scope.quoteRef,recType:recType, glCode: glCode, custName: $scope.quotes.groupName, 
					cashier: cashier, stnName:$scope.station, stnNum:$scope.stationNum, amtdue: Number($scope.recamtCP) , amttendered: Number($scope.tendamtCP), change: Number($scope.changeamtCP),payMeth:$scope.payMethCP};
			}else {
				var newRec = {recNum: $scope.RecNo, transNo: $scope.newTransNo, recBatch:$scope.newBatch, recDate: $scope.recDate, quoteRef: $scope.quoteRef,recType:recType, glCode: glCode, custName: $scope.quotes.groupName, 
					cashier: cashier, stnName:$scope.station, stnNum:$scope.stationNum, amtdue: Number($scope.recamtCP) , amttendered: Number($scope.tendamtCP), change: Number($scope.changeamtCP),payMeth:$scope.payMethCP,cheQue: newCheque};
			}


                //Check if Receipt is Valid
                if ((($scope.paymentMethod == "Cash") || ($scope.paymentMethod == "Cheque"))&&($scope.change >= 0)&&($scope.CUSTOMERname != null)) {
			capRec = [
			  '<body>',
              '<table>',
              '<tr><td colspan=2><center><u><b>Swaziland Electricity Company</b></u></center></td></tr>',
              '<tr><td colspan=2><center><b>Payment Receipt</b></center></td></tr>',
			  '<tr><td><span><b>Receipt No:</b></span></td><td><span><i>'+$scope.RecNo+'</i></span></td></tr>',
			  '<tr><td><span><b>Batch No:</b></span></td><td><span><i>'+$scope.newBatch+'</i></span></td></tr>',
			  '<tr><td><span><b>Transaction No:</b></span></td><td><span><i>'+$scope.newTransNo+'</i></span></td></tr>',
			  '<tr><td><span><b>Date:</b></span></td><td><span><i>'+$scope.recDate+'</i></span></td></tr>',
			  '<tr><td><span><b>Quotation:</b></span></td><td><span><i>'+$scope.quoteRef+'</i></span></td></tr></table>',
			  '<table><tr><td><span>'+$scope.quotes.groupName+'</span><br></td><td>&nbsp;</td></tr></table>',
			  '<table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span><b>CURRENT BALANCE</b></span></td><td><span><i>'+$("#quotebal").text()+'</i></span></td></tr>',
			  '<tr><td><span><b>Paid By:</b></span></td><td><span><i>'+$scope.payMethCP+'</i></span></td></tr>',
			  '<tr><td><span><b>Amount:</b></span></td><td><span><i>'+$("#recamtcp").text()+'</i></span></td></tr>',
			  '<tr><td><span><b>Tendered:</b></span></td><td><span><i>'+$("#tendamtcp").text()+'</i></span></td></tr>',
			  '<tr><td><span><b>Change:</b></span></td><td><span><i>E '+$("#changeamtcp").text()+'</i></span></td></tr>',
			  '<tr><td><span><b>Cashier:</b></span></td><td><span><i>'+$scope.cashierName+'--'+$scope.cashierSurname+'</i></span></td></tr>',
			  '<tr><td><span><b>Station:</b></span></td><td><span><i>'+$scope.station+'</i></span></td></tr>',
			  '</table>',
			  '</body>',
		          '<hr>'].join('\n');
			  //console.log(spuRec);
			  $http.post('http://localhost:3080/print', {spuRec:capRec}).success(function (resp) {
			    console.log(resp);
			  });

		}
		} else if (recType == 'otherPayments') {

			if ($scope.choseCheque) {
				$scope.chequeTot = $scope.recamtOP;
			}

			$scope.paymentMethod = $scope.payMethOP;
			$scope.change = $scope.changeamtOP;
			$scope.CUSTOMERname = $scope.custNameOther;
			
			var newCheque = {chequeTot:$scope.chequeTot, chequeNo: $scope.chequeNoOP, bankCode: $scope.bankCodeOP, drawerName: $scope.drawerNameOP};

			if ($scope.payMethOP == "Cash") {
				var newRec = {recNum: $scope.RecNo, transNo: $scope.newTransNo, recBatch:$scope.newBatch,recDate: $scope.recDate, recType:recType, custName: $scope.custNameOther, glCode: $scope.glCodeOP, 
					cashier: cashier, stnName:$scope.station, stnNum:$scope.stationNum, amtdue: Number($scope.recamtOP), amttendered: Number($scope.tendamtOP), change: Number($scope.changeamtOP),payMeth:$scope.payMethOP};
			}else {
				var newRec = {recNum: $scope.RecNo, transNo: $scope.newTransNo, recBatch:$scope.newBatch,recDate: $scope.recDate, recType:recType, custName: $scope.custNameOther,glCode: $scope.glCodeOP, 
					cashier: cashier, stnName:$scope.station, stnNum:$scope.stationNum, amtdue: Number($scope.recamtOP), amttendered: Number($scope.tendamtOP), change: Number($scope.changeamtOP),payMeth:$scope.payMethOP, cheQue: newCheque};
			}

                //Check if Receipt is Valid
                if ((($scope.paymentMethod == "Cash") || ($scope.paymentMethod == "Cheque"))&&($scope.change >= 0)&&($scope.CUSTOMERname != null)) {
			//PRINT OTHER PAYMENTS RECEIPT
			opRec = [
			  	'<body>',
                                '<table>',
                                '<tr><td colspan=2><center><u><b>Swaziland Electricity Company</b></u></center></td></tr>',
                                '<tr><td colspan=2><center><b>Payment Receipt</b></center></td></tr>',
			  	'<tr><td><span><b>Receipt No:</b></span></td><td><span><i>'+$scope.RecNo+'</i></span></td></tr>',
			  	'<tr><td><span><b>Batch No:</b></span></td><td><span><i>'+$scope.newBatch+'</i></span></td></tr>',
			  	'<tr><td><span><b>Transaction No:</b></span></td><td><span><i>'+$scope.newTransNo+'</i></span></td></tr>',
			  	'<tr><td><span><b>Date:</b></span></td><td><span><i>'+$scope.recDate+'</i></span></td></tr>',
			  	'<tr><td><span><b>Customer :</b></span></td><td><span><i>'+$scope.custNameOther+'</i></span></td></tr></table>',
			  	'<table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span><b>OTHER</b></span></td><td><span><i>'+$("#recamtop").text()+'</i></span></td></tr>',
			  	'<tr><td><span><b>Method:</b></span></td><td><span><i>'+$scope.payMethOP+'</i></span></td></tr>',
			  	'<tr><td><span><b>Tendered:</b></span></td><td><span><i>'+$("#tendamtop").text()+'</i></span></td></tr>',
			  	'<tr><td><span><b>Change:</b></span></td><td><span><i>E '+$("#changeamtop").text()+'</i></span></td></tr>',
			  	'<tr><td><span><b>Cashier:</b></span></td><td><span><i>'+$scope.cashierName+'--'+$scope.cashierSurname+'</i></span></td></tr>',
			  	'<tr><td><span><b>Station:</b></span></td><td><span><i>'+$scope.station+'</i></span></td></tr>',
			  	'</table>',
			  	'</body>',
			        '<hr>'].join('\n');
			  	//console.log(spuRec);
			$http.post('http://localhost:3080/print', {spuRec:opRec}).success(function (resp) {
			   	console.log(resp);
			});
		}
		} else if (recType == 'visits') {

			if ($scope.choseCheque) {
				$scope.chequeTot = $scope.recamtVT;
			}

			$scope.paymentMethod = $scope.payMethVT;
			$scope.change = $scope.changeamtVT;
			$scope.CUSTOMERname = $scope.custNameVT;
			
			var glCode = "HF008888089";
			var newCheque = {chequeTot:$scope.chequeTot, chequeNospu: $scope.chequeNoVT, bankCode: $scope.bankCodeVT, drawerName: $scope.drawerNameVT};
			
			if ($scope.payMethVT == "Cash") {
				var newRec = {recNum: $scope.RecNo, transNo: $scope.newTransNo, recBatch:$scope.newBatch, recDate: $scope.recDate,recType:recType, custName:$scope.custNameVT,glCode: glCode, 
					cashier: cashier, stnName:$scope.station, stnNum:$scope.stationNum, amtdue: Number($scope.recamtVT),amttendered: Number($scope.tendamtVT), change: Number($scope.changeamtVT),payMeth:$scope.payMethVT};
			}else {
				var newRec = {recNum: $scope.RecNo, transNo: $scope.newTransNo, recBatch:$scope.newBatch, recDate: $scope.recDate,recType:recType, custName:$scope.custNameVT,glCode: glCode, 
					cashier: cashier, stnName:$scope.station, stnNum:$scope.stationNum, amtdue: Number($scope.recamtVT),amttendered: Number($scope.tendamtVT), change: Number($scope.changeamtVT),payMeth:$scope.payMethVT,cheQue: newCheque};
			}

                //Check if Receipt is Valid
                if ((($scope.paymentMethod == "Cash") || ($scope.paymentMethod == "Cheque"))&&($scope.change >= 0)&&($scope.CUSTOMERname != null)) {
			//PRINT VISIT RECEIPT
			vtRec = [
			  	'<body>',
                                '<table>',
                                '<tr><td colspan=2><center><u><b>Swaziland Electricity Company</b></u></center></td></tr>',
                                '<tr><td colspan=2><center><b>Payment Receipt</b></center></td></tr>',
			  	'<tr><td><span><b>Receipt No:</b></span></td><td><span><i>'+$scope.RecNo+'</i></span></td></tr>',
			  	'<tr><td><span><b>Batch No:</b></span></td><td><span><i>'+$scope.newBatch+'</i></span></td></tr>',
			  	'<tr><td><span><b>Transaction No:</b></span></td><td><span><i>'+$scope.newTransNo+'</i></span></td></tr>',
			  	'<tr><td><span><b>Date:</b></span></td><td><span><i>'+$scope.recDate+'</i></span></td></tr>',
			  	'<tr><td><span><b>Customer :</b></span></td><td><span><i>'+$scope.custNameVT+'</i></span></td></tr></table>',
			  	'<table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span><b>VISIT FEE</b></span></td><td><span><i>'+$("#recamtvt").text()+'</i></span></td></tr>',
			  	'<tr><td><span><b>Method:</b></span></td><td><span><i>'+$scope.payMethVT+'</i></span></td></tr>',
			  	'<tr><td><span><b>Tendered:</b></span></td><td><span><i>'+$("#tendamtvt").text()+'</i></span></td></tr>',
			  	'<tr><td><span><b>Change:</b></span></td><td><span><i>E '+$("#changeamtvt").text()+'</i></span></td></tr>',
			  	'<tr><td><span><b>Cashier:</b></span></td><td><span><i>'+$scope.cashierName+'--'+$scope.cashierSurname+'</i></span></td></tr>',
			  	'<tr><td><span><b>Station:</b></span></td><td><span><i>'+$scope.station+'</i></span></td></tr>',
			  	'</table>',
				'</body>',
			        '<hr>'].join('\n');
			//console.log(spuRec);
			$http.post('http://localhost:3080/print', {spuRec:vtRec}).success(function (resp) {
			   console.log(resp);
			});
		}
		} else if (recType == 'deposits') {
			
			if ($scope.choseCheque) {
				$scope.chequeTot = $scope.recamtDP;
			}

			$scope.paymentMethod = $scope.payMethDP;
			$scope.change = $scope.changeamtDP;
			$scope.CUSTOMERname = $scope.customerDP.NAME;

			var glCode = "HF008888012";
			var newCheque = {chequeTot:$scope.chequeTot, chequeNo: $scope.chequeNoDP, bankCode: $scope.bankCodeDP, drawerName: $scope.drawerNameDP};

			if ($scope.payMethDP == "Cash") {
				var newRec = {recNum: $scope.RecNo, transNo: $scope.newTransNo, recBatch:$scope.newBatch, recDate: $scope.recDate, account: $scope.accountDP,recType:recType, glCode: glCode, custName:$scope.customerDP.NAME, 
					cashier: cashier, stnName:$scope.station, stnNum:$scope.stationNum, amtdue: Number($scope.recamtDP), amttendered: Number($scope.tendamtDP), change: Number($scope.changeamtDP),payMeth:$scope.payMethDP};
			}else {
				var newRec = {recNum: $scope.RecNo, transNo: $scope.newTransNo, recBatch:$scope.newBatch, recDate: $scope.recDate, account: $scope.accountDP,recType:recType, glCode: glCode, customer: $scope.customerDP.NAME, 
					cashier: cashier, stnName:$scope.station, stnNum:$scope.stationNum, amtdue: Number($scope.recamtDP), amttendered: Number($scope.tendamtDP), change: Number($scope.changeamtDP),payMeth:$scope.payMethDP,cheQue: newCheque};
			}

                //Check if Receipt is Valid
                if ((($scope.paymentMethod == "Cash") || ($scope.paymentMethod == "Cheque"))&&($scope.change >= 0)&&($scope.CUSTOMERname != null)) {
			//PRINT DEPOSIT RECEIPT
			depRec = [
			  '<body>',
                          '<table>',
                          '<tr><td colspan=2><center><u><b>Swaziland Electricity Company</b></u></center></td></tr>',
                          '<tr><td colspan=2><center><b>Payment Receipt</b></center></td></tr>',
			  '<tr><td><span><b>Receipt No:</b></span></td><td><span><i>'+$scope.RecNo+'</i></span></td></tr>',
			  '<tr><td><span><b>Batch No:</b></span></td><td><span><i>'+$scope.newBatch+'</i></span></td></tr>',
			  '<tr><td><span><b>Transaction No:</b></span></td><td><span><i>'+$scope.newTransNo+'</i></span></td></tr>',
			  '<tr><td><span><b>Date:</b></span></td><td><span><i>'+$("#spuDate").text()+'</i></span></td></tr>',
			  '<tr><td><span><b>Account #:</b></span></td><td><span><i>'+$scope.accountDP+'</i></span></td></tr></table>',
			  '<table><tr><td><span>'+$scope.customerDP.NAME+'</span><br><span>'+$scope.customerDP.Address+'</span><br><span>'+$scope.customerDP.City+'</span></td><td>&nbsp;</td></tr></table>',
			  '<table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span><b>DEPOSIT</b></span></td><td><span><i>'+$("#recamtdp").text()+'</i></span></td></tr>',
			  '<tr><td><span><b>Method:</b></span></td><td><span><i>'+$scope.payMethDP+'</i></span></td></tr>',
			  '<tr><td><span><b>Tendered:</b></span></td><td><span><i>'+$("#tendamtdp").text()+'</i></span></td></tr>',
			  '<tr><td><span><b>Change:</b></span></td><td><span><i>'+$("#changeamtdp").text()+'</i></span></td></tr>',
			  '<tr><td><span><b>Cashier:</b></span></td><td><span><i>'+$scope.cashierName+'--'+$scope.cashierSurname+'</i></span></td></tr>',
			  '<tr><td><span><b>Station:</b></span></td><td><span><i>'+$scope.station+'</i></span></td></tr>',
			  '</table>',
			  '</body>',
			  '<hr>'].join('\n');
			  //console.log(spuRec);
			  $http.post('http://localhost:3080/print', {spuRec:depRec}).success(function (resp) {
			    console.log(resp);
			  });
		}
		}

		$scope.recInserted = false;
		if (($scope.paymentMethod == "Cash") || ($scope.paymentMethod == "Cheque")) {
			if ($scope.change >= 0) {
				if ($scope.CUSTOMERname != null) {
					$scope.payMethodIsNotSet = false;
					$scope.changeIsNotValid = false;
					$scope.nameIsEmpty = false;

					$http.post('/addNewReceipt', newRec ).success(function (resp) {
						console.log(resp);

						$scope.recInserted = true;
						$scope.recInsertedMsg = resp;
						console.log($scope.recInsertedMsg);
						$scope.insertReceiptMessageFunction(recType);

						if (recType == "spu") {
							//$scope.updateAutoIncVals($scope.st.code, $scope.newRecNo);
							$scope.updateAutoIncVals($scope.stationCode, $scope.newRecNo, $scope.newTransNo);
							$scope.getIncVals();
							$scope.updateAging();
							$scope.clearInsertSpuRec();
						}
						else if(recType == "capital"){
							$scope.updateAutoIncVals($scope.stationCode, $scope.newRecNo, $scope.newTransNo);
							$scope.getIncVals();
							$scope.updateQuotation();
							$scope.clearInsertCapitalRec();
						}
						else if(recType == "otherPayments"){
							$scope.updateAutoIncVals($scope.stationCode, $scope.newRecNo, $scope.newTransNo);
							$scope.getIncVals();
							$scope.clearInsertOtherPRec();
						}
						else if(recType == "visits"){
							$scope.updateAutoIncVals($scope.stationCode, $scope.newRecNo, $scope.newTransNo);
							$scope.getIncVals();
							$scope.clearInsertVisitsRec();
						}
						else if(recType == "deposits"){
							$scope.updateAutoIncVals($scope.stationCode, $scope.newRecNo, $scope.newTransNo);
							$scope.getIncVals();
							$scope.clearInsertDepositsRec();
						}
					}).error(function () {
						alert("Error");
					});
				} else {
					$scope.nameIsEmpty = true;
					$scope.nameErrorMsg = "Customer details NOT Valid";
					$scope.insertReceiptMessageFunction(recType);
				}
			} else {
				$scope.changeIsNotValid = true;
				$scope.changeErrorMsg = "Tendered Amount should be more than Due Amount";
				$scope.insertReceiptMessageFunction(recType);
			}
		} else {
			$scope.payMethodIsNotSet = true;
			$scope.payMethodErrorMsg = "Select Valid Payment Method";
			$scope.insertReceiptMessageFunction(recType);
		}

	if ($scope.newGLBox){
		$scope.insertGlCode();
	} // end insert gl code function
}// end insert add receipt function

$scope.messageExists = false;
$scope.insertReceiptMessageFunction = function (type){
	if (($scope.recInserted)||($scope.nameIsEmpty)||($scope.changeIsNotValid)||($scope.payMethodIsNotSet)) {

		switch (type){
			case "spu" : $scope.messageExistsSpu = true;break;
			case "capital" : $scope.messageExistsCP = true;break;
			case "visits" : $scope.messageExistsVT = true;break;
			case "deposits" : $scope.messageExistsDP = true;break;
			case "otherPayments" : $scope.messageExistsOP = true;break;
		};
	};
}

	//reset messages div
	$scope.resetMessagesDiv = function (){
		if (($scope.payMethSPU!='--Select--')||($scope.payMethCP!='--Select--')||($scope.payMethVT!='--Select--')||($scope.payMethDP!='--Select--')||($scope.payMethOP!='--Select--')) {
			$scope.payMethodIsNotSet = false;
		}	
		$scope.messageExistsSpu = false;
		$scope.messageExistsCP = false;
		$scope.messageExistsVT = false;
		$scope.messageExistsDP = false;
		$scope.messageExistsOP = false;
	}

	$scope.insertQuote = function () {
		var type = {name:"CAPITAL ACCOUNT", gl:"GL999999999"};
		var newQuote = {recNum: $scope.recno, recType: type, recBatch:$scope.recBatch, group: {grpRef: $scope.quoteRef, description: $scope.quotes.groupName}, 
			user: {name:$scope.cashierName, surname: $scope.cashierSurname}, station:$scope.st, amtdue: $scope.recamt , transNo: $scope.transno};

		$http.post('/addNewQuote', newQuote ).success(function (resp) {
			$scope.clearInsertQuote();
			
		}).error(function () {
			alert("Error");
		});
	}

	$scope.clearInsertSpuRec = function () {
		$scope.accountSPU = '';
		$scope.recamtSPU = '';
		
		if (!($scope.isMultiPay)) {
			$scope.tendamtSPU = '';
			$scope.payMethSPU = '--Select--';
		}
		$scope.customerSPU.Current_Balance = '';
		$scope.changeamtSPU = '';
		$scope.customerSPU.Address = '';
		$scope.customerSPU.NAME = '';
		$scope.customerSPU.City = '';
	}


	$scope.clearInsertVisitsRec = function () {
		$scope.custNameVT = '';
		$scope.recamtVT = '';

		//soft reset if multipay
		if (!($scope.isMultiPay)) {
			$scope.tendamtVT = '';
			$scope.payMethVT = '--Select--';
		}
		$scope.changeamtVT = '';
		}

	$scope.clearInsertDepositsRec = function () {
		$scope.accountDP = '';
		$scope.recamtDP = '';
                
		//soft reset if multipay
                if (!($scope.isMultiPay)) {
                        $scope.tendamtDP = '';
                        $scope.payMethDP = '--Select--';
                }
		$scope.changeamtDP = '';
		$scope.customerDP.NAME = '';
		$scope.customerDP.Address = '';
		$scope.customerDP.City = '';
	}

	$scope.clearInsertOtherPRec = function () {
		$scope.custNameOther = '';
		$scope.glCodeOP = '';
		$scope.glCodeDesc = '';
		$scope.recamtOP = '';

		//set soft reset if multipay
		if (!($scope.isMultiPay)) {
			$scope.tendamtOP = '';
			$scope.payMethOP = '--Select--';
		}

		$scope.recType = '';
		$scope.changeamtOP = '';
	}

	$scope.clearInsertCapitalRec = function () {
		$scope.quoteRef = '';
		$scope.recamtCP = '';

		//set soft reset if multipay
		if (!($scope.isMultiPay)) {
			$scope.tendamtCP = '';
			$scope.payMethCP = '--Select--';
		}
		$scope.changeamtCP = '';
		// $scope.quotes.balance = '';
		$scope.quotes.groupName = '';
	}

	$scope.clearInsertQuote = function () {
		$scope.recno = '';
		$scope.recBatch = '';
		$scope.quoteRef = '';
		$scope.quotes.groupName = '';
		$scope.cashierName = '';
		$scope.cashierSurname = '';
		$scope.transno = '';
	}

	$scope.calcChange = function(type,tendamt, recamt){
		switch (type) {
			case "spu" :
	    		$scope.changeamtSPU = Number(tendamt) - Number(recamt);
			    if ($scope.isMultiPay) {
			    	if (($scope.changeamtSPU > 0) && (($scope.balance == $scope.cashTot)||($scope.balance == $scope.chequeTot))) {
			    		$scope.mPayPos = "B";
			    	} else if ($scope.changeamtSPU > 0) {
						$scope.mPayPos = "M";
					} else if ($scope.changeamtSPU == 0) {
						$scope.mPayPos = "E";
			}
			break;
	    	case "capital" :
	    		$scope.changeamtCP = Number(tendamt) - Number(recamt);break;
	    	case "otherPayments" :
	    		$scope.changeamtOP = Number(tendamt) - Number(recamt);break;
	    	case "deposits" :
	    		$scope.changeamtDP = Number(tendamt) - Number(recamt);break;
	    	case "visits" :
	    		$scope.changeamtVT = Number(tendamt) - Number(recamt);break;
		}
	}

 	$scope.getCancelRec = function (recId) {
		var idD = recId;			
		$http.post('/getReceipt/' + idD).success(function(data) {
			$scope.receiptNo = '';
			$scope.recNum = data.recNum;
		    $scope.cashier = data.cashier;
		    $scope.cust = data.cust;
		    $scope.station = data.station;
		    $scope.amtdue = data.amtdue;
		    $scope.hasinfo = true;
		});
	}

	$scope.clearCancelRec = function () {
	    $scope.hasinfo = false;
		$scope.id = '';
		$scope.user = '';
		$scope.cust = '';
		$scope.station = '';
		$scope.amtdue = '';
		$scope.receiptNoC = '';
	}

	$scope.cancelCancelRec = function () {
	    $scope.hasinfo = false;
		$scope.clearCancelRec();
	}

	$scope.cancelReceipt = function (recId) {
		var idD = recId;

		$http.post('/cancelRec/' + idD).success (function (resp) {
			alert(resp);
			$scope.clearCancelRec();
		})
	}

    //MultiPay Operations

	$scope.id='';
	$scope.isMultiPay = false;
	$scope.payMeth = "--Select--";
	//$scope.payMethSPU = 'Cash';
	$scope.bankCode = '';
	$scope.drawerName = '';
	//$scope.payMethSPU = ["--Select--", "Cash", "Cheque"]; ?????
	
	$scope.closeMultiPay = function() {
		$scope.isMultiPay = false;
	}

	$scope.testCash = function (payMeth) {
		//var test = payMeth;
		if ($scope.payMeth == 'Cash') {
			return true;
		}
	}

	$scope.testCheque = function (payMeth) {
		//var test = payMeth;
		if ($scope.payMeth == 'Cheque') {
			return true;
		}
	}

	$scope.cancelMultiPayProcess = function (){
		$scope.id='';
		$scope.payMeth = '--Select--';
		$scope.chequeNo = '';
		$scope.bankCode = '';
		$scope.drawerName = '';
		$scope.balance = '';
		$scope.cashTot = '';
		$scope.chequeTot = '';
	}

	$scope.acceptMultiPay = function (){
		$scope.mPayID= 17;
		$scope.isMultiPay = true;

		$scope.bankCodeSPU=$scope.bankCode;
		$scope.bankCodeCP=$scope.bankCode;		
		$scope.bankCodeDP=$scope.bankCode;
		$scope.bankCodeVT=$scope.bankCode;
		$scope.bankCodeOP=$scope.bankCode;

		$scope.chequeNoSPU=$scope.chequeNo;
		$scope.chequeNoCP=$scope.chequeNo;
		$scope.chequeNoDP=$scope.chequeNo;
		$scope.chequeNoVT=$scope.chequeNo;
		$scope.chequeNoOP=$scope.chequeNo;
		
		$scope.drawerNameSPU=$scope.drawerName;
		$scope.drawerNameCP=$scope.drawerName;
		$scope.drawerNameDP=$scope.drawerName;
		$scope.drawerNameVT=$scope.drawerName;
		$scope.drawerNameOP=$scope.drawerName;

		if ($scope.payMeth == 'Cash') {
			//set Pay Method
			$scope.payMethSPU = 'Cash';
			$scope.payMethCP = 'Cash';
			$scope.payMethDP = 'Cash';
			$scope.payMethVT = 'Cash';
			$scope.payMethOP = 'Cash';
			$scope.balance = $scope.cashTot;
			//set tendered Amount
			$scope.tendamtSPU = $scope.balance;
			$scope.tendamtCP = $scope.balance;
			$scope.tendamtDP = $scope.balance;
			$scope.tendamtVT = $scope.balance;
			$scope.tendamtOP = $scope.balance;

		}else if ($scope.payMeth == 'Cheque'){
			//set Pay Method
			$scope.balance = $scope.chequeTot;
			$scope.payMethSPU = 'Cheque';
			$scope.payMethCP = 'Cheque';
			$scope.payMethDP = 'Cheque';
			$scope.payMethVT = 'Cheque';
			$scope.payMethOP = 'Cheque';
			//set tendered Amount
			$scope.tendamtSPU = $scope.balance;
			$scope.tendamtCP = $scope.balance;
			$scope.tendamtDP = $scope.balance;
			$scope.tendamtVT = $scope.balance;
			$scope.tendamtOP = $scope.balance;
		}

	}

	/*$scope.acceptPayMeth = function(){
		$('#payMethSPU').val($scope.payMeth);
		$('#payMethSPU').trigger('change');
	}*/

	$scope.initMultiPay = function () {
		$scope.id='';
		$scope.payMeth = '--Select--';
		$scope.chequeNo = '';
		$scope.bankCode = '';
		$scope.drawerName = '';
		$scope.balance = '';
		$scope.cashTot = '';
		$scope.chequeTot = '';
	}

	$scope.mPayCheck = function () {
		if ($scope.isMultiPay) {
			return true;
		}
	}

	$scope.mPayChange = function(){
	    	$scope.changeamt = Number($scope.balance) - Number($scope.recamt);
	    	$scope.balance = $scope.changeamt;
	}


	$scope.multiPayDecreament = function(chng){
		if (chng>=0){
			if ($scope.isMultiPay) {
				var change = chng;
				$scope.balance = change;
	
				//set Change as New Tendered Amount
				$scope.tendamtSPU = change.toFixed(2);
				$scope.tendamtCP = change.toFixed(2);
				$scope.tendamtDP = change.toFixed(2);
				$scope.tendamtVT = change.toFixed(2);
				$scope.tendamtOP = change.toFixed(2);

				if ($scope.balance>0.00){
					$scope.isMultiPay = true;
				} else if ($scope.balance <= 0.00) {
					$scope.isMultiPay = false;
					$scope.tendamtSPU = '';
					$scope.tendamtCP = '';
					$scope.tendamtDP = '';
					$scope.tendamtVT = '';
					$scope.tendamtOP = '';
				}
			}
		}
	}

	$scope.printBatchTotal = function(){
      batchTotal = [
		  '<center><u><b>Swaziland Electricity Company</b></u></center>',
		  '<p></p><center><b>Batch Totals Report</b></center>',
		  '<p></p><p>',
		  '<center>',
		  '<table>',
		  '<tr><td><span><b>Batch Number:</b></span></td><td><span><i>H63</i></span></td></tr>',
		  '<tr><td><span><b>Date:</b></span></td><td><span><i>Tue Nov 11 2014 02:47:31</i></span></td></tr>',
		  '</table><p></p>',
		  '<table>',
		  '<tr><td><span><b>Cash Amount:</b></span></td><td><span><i>E 11,039</i></span></td></tr>',
		  '<tr><td><span><b>Cheque Amount:</b></span></td><td><span><i>E 0.00</i></span></td></tr>',
		  '<tr><td><span><b>Bankable Total:</b></span></td><td><span><i><u><b>E 11,039</b></u></i></span></td></tr>',
		  '<tr><td><span><b>Speed Point Amount:</b></span></td><td><span><i>E 0.00</i></span></td></tr>',
		  '<tr><td><span><b>Bank Transfers:</b></span></td><td><span><i>E 0.00</i></span></td></tr>',
		  '<tr><td><span><b>Non-Bankable Total:</b></span></td><td><span><i><u><b>E 0.00</b></u></i></span></td></tr>',
		  '<tr><td><span><b>Batch Total:</b></span></td><td><span><i><u><b>E 11,039</b></u></i></span></td></tr>',
		  '<tr><td><span><b>Cashier:</b></span></td><td><span><i>Alpha Dovoza</i></span></td></tr>',
		  '<tr><td><span><b>Station:</b></span></td><td><span><i>HQ</i></span></td></tr>',
		  '</table>',
		  '</center>'].join('\n');
	  //console.log(spuRec);
	  $http.post('http://localhost:3080/print', {spuRec:batchTotal}).success(function (resp) {
	    console.log(resp);
	  });
    }

}]);

// QUOTATION CONTROLLER

receipt.controller('quotationCtrl', ['$scope','$http','$compile','recSwitch', function($scope, $http,$compile, recSwitch){
	$scope.testing = "Bristo";

	$scope.showQuotes = function(){
		
		$http.post('/showAllQuotes').success(function (data) {

			quoteData = '';
			data.forEach(function(quotation){
				quoteData += '<tr><td>'+quotation.Quot_OrderQuoteID+'</td><td>'+quotation.Quot_Description.substr(14)+'</td><td>'+quotation.Quot_CreatedBy+'</td><td>'+quotation.Quot_CreatedDate+'</td></tr>';
			});
			
			$('#showQuotesTblData').html('');
			var $quoteData1 = $(quoteData).appendTo('#showQuotesTblData');
			$compile($quoteData1)($scope);
			$('.quotetable').dataTable();
			
			// log show quotations event
			var log = {action : "showQuotations", actionBy:"Bristo", station : "station", time : Date().toString()};
            	recSwitch.insertLog(log).success(function () {
            });

		});
    }
    
	$scope.addQuote = function(){
		alert("testing.....");

		if ($scope.custNo == undefined) {
			alert("Enter Customer ID");
			return; 
		};
		// quotation object definition
		var newquote = {CUSTNO: $scope.custNo, CUSTNAME:$scope.custName, CUSTADDR1 : $scope.custAddr1, CUSTADDR3: $scope.custAddr2, CUSTADDR3: $scope.custAddr3, CUSTREF:$scope.custRef};

		$http.post('/addNewQuote', newcustomer ).success(function (resp) {
			alert(resp);
			$scope.clearNewQuote();

		}).error(function () {
			alert("Error");
		});
	}

	$scope.clearNewQuote = function () {
		$scope.custNo = '';
		$scope.custName = '';
		$scope.custAddr1 = '';
		$scope.custAddr2 = '';
		$scope.custAddr2 = '';
		$scope.custRef = '';
	}

	$scope.getEditQuote = function (custno) {
		var id = custno;
		
		$http.post('/getQuote/' + id).success(function(data) {
			// initialise model with database customer values
	      	$scope.custNoU = data[0].CUSTNO;
	      	$scope.custNameU = data[0].CUSTNAME;
	      	$scope.custAddr1U = data[0].CUSTADDR1;
	      	$scope.custAddr2U= data[0].CUSTADDR2;
	      	$scope.custAddr3U = data[0].CUSTADDR3;
	      	$scope.custRefU = data[0].CUSTREF; //array of user
	    });// $http.get ends
	}

	$scope.updateQuote = function (custId) {
		var id = custId;
		if (id == undefined) {
			alert("Id empty");
			return;
		}
		// update quote object definition
		var updatequote = {custno: $scope.custNoU, custName:$scope.custNameU, custAddr1 : $scope.custAddr1U, custAddr2: $scope.custAddr2U, custAddr3: $scope.custAddr3U, custRef:$scope.custRefU};

		$http.post('/updateCustomer/' + id, updatecustomer).success(function (resp) {
			alert(resp);
			$scope.clearEditQuote();
		}).error(function () {
			alert("Error");
		});
	}

	$scope.removeQuote = function (uname) {

		var id = uname;
		$http.delete('/deleteQuote/' + id).success(function(resp) {
			alert(resp);
		}).error(function () {
				alert("Error");
		});
	}

	$scope.clearEditCustomer = function () {
		$scope.custIdU = '';
	    $scope.custNameU = '';
	    $scope.custAddr1 = '';
	    scope.custAddr2 = '';
	    $scope.custAddr3 = '';
	    $scope.custRefU = ''; //array of user
	}
}]); // quotation controler ends

/*receipt.controller('multiPayCtrl', ['$scope','$http', 'recSwitch','recTypeService', function($scope, $http, recSwitch, recTypeService){

	
		
}]);*/


